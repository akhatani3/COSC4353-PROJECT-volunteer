<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Volunteer Home</title>
  <link href="style.css" rel="stylesheet" type="text/css">

  <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>

  <script>
  function toggleTheme() {
    const html = document.documentElement;
    if (html.getAttribute('data-theme') === 'dark') {
      html.setAttribute('data-theme', 'light');
      localStorage.setItem('theme', 'light');
    } else {
      html.setAttribute('data-theme', 'dark');
      localStorage.setItem('theme', 'dark');
    }
  }

  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
</head>

<body>
  <header>
    <div style="display:flex;align-items:center;gap:14px;">
      <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" 
           alt="Profile Picture" class="profile-pic">
      <h1>Welcome, <span id="greetName">Volunteer</span>!</h1>
    </div>

    <div style="display:flex;align-items:center;gap:16px;">
      <div class="notif-bell" id="notifBell" data-count="0">ðŸ””</div>
      <nav>
        <a href="profile.html">Profile</a>
        <button id="logoutBtn">Logout</button>
      </nav>
    </div>

    <div class="notif-panel" id="notifPanel">
      <ul id="notifList"></ul>
    </div>
  </header>

  <div id="message" class="msg"></div>

  <table id="eventsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Date</th>
        <th>Location</th>
        <th>Skills</th>
        <th>Urgency</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ðŸŒŸ Event Details Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalEventName"></h2>
      <p><strong>Date:</strong> <span id="modalDate"></span></p>
      <p><strong>Location:</strong> <span id="modalLocation"></span></p>
      <p><strong>Required Skills:</strong> <span id="modalSkills"></span></p>
      <p><strong>Urgency:</strong> <span id="modalUrgency"></span></p>
      <button id="joinBtnModal">Join Event</button>
    </div>
  </div>

  <script>
    const profile = JSON.parse(localStorage.getItem('currentUser'));
    if (!profile) {
      alert('Not logged in.');
      window.location.href = 'index.html';
    }
    if (profile.role === 'admin') {
      alert('Admins cannot access volunteer home.');
      window.location.href = 'event-management.html';
    }

    // Set profile info
    document.getElementById('greetName').textContent = profile.name || 'Volunteer';
    if (profile.profilePic) document.getElementById('profilePic').src = profile.profilePic;

    const eventsKey = 'va_events';
    const historyKey = 'va_history';
    const notifKey = 'va_notifications_' + profile.email;
    const msg = document.getElementById('message');
    const notifBell = document.getElementById('notifBell');
    const notifPanel = document.getElementById('notifPanel');
    const notifList = document.getElementById('notifList');
    const logoutBtn = document.getElementById('logoutBtn');

    // Modal elements
    const modal = document.getElementById('eventModal');
    const modalClose = modal.querySelector('.close');
    const joinBtnModal = document.getElementById('joinBtnModal');
    let currentEvent = null;

    // Helpers
    const getEvents = () => JSON.parse(localStorage.getItem(eventsKey) || '[]');
    const getHistory = () => JSON.parse(localStorage.getItem(historyKey) || '[]');
    const saveHistory = arr => localStorage.setItem(historyKey, JSON.stringify(arr));
    const getNotifs = () => JSON.parse(localStorage.getItem(notifKey) || '[]');
    const saveNotifs = arr => localStorage.setItem(notifKey, JSON.stringify(arr));

    // Render events
    function renderEvents() {
      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '';
      const events = getEvents();
      const history = getHistory();

      if (events.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="text-align:center;color:#94a3b8;">No events available yet</td>`;
        tbody.appendChild(tr);
        return;
      }

      events.forEach(ev => {
        const alreadyJoined = history.some(
          h => h.volunteer === profile.email && h.eventName === ev.eventName && h.eventDate === ev.eventDate
        );

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="#" class="event-link" data-evt='${JSON.stringify(ev)}'>${ev.eventName}</a></td>
          <td>${ev.eventDate}</td>
          <td>${ev.location}</td>
          <td>${ev.reqSkills.join(', ')}</td>
          <td>${ev.urgency}</td>
          <td>
            ${alreadyJoined 
              ? '<span style="color:#22c55e;font-weight:bold;">Joined</span>'
              : `<button data-evt='${JSON.stringify(ev)}'>Join</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
          const ev = JSON.parse(e.target.dataset.evt);
          joinEvent(ev);
        });
      });

      tbody.querySelectorAll('.event-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const ev = JSON.parse(e.target.dataset.evt);
          openModal(ev);
        });
      });
    }

    // Join event
    function joinEvent(ev) {
      const history = getHistory();
      history.push({
        volunteer: profile.email,
        eventName: ev.eventName,
        eventDate: ev.eventDate,
        location: ev.location,
        requiredSkills: ev.reqSkills,
        urgency: ev.urgency,
        status: 'Joined'
      });
      saveHistory(history);

      // Notification
      const notifs = getNotifs();
      notifs.unshift({
        message: `You joined "${ev.eventName}" (${ev.eventDate})`,
        time: new Date().toLocaleString()
      });
      saveNotifs(notifs);

      msg.textContent = `You successfully joined: ${ev.eventName}`;
      setTimeout(() => msg.textContent = '', 3000);

      renderEvents();
      renderNotifs();
      modal.style.display = 'none';
    }

    // Notifications
    function renderNotifs() {
      const notifs = getNotifs();
      notifList.innerHTML = '';
      notifs.forEach(n => {
        const li = document.createElement('li');
        li.textContent = `${n.message} â€” ${n.time}`;
        notifList.appendChild(li);
      });
      notifBell.setAttribute('data-count', notifs.length);
    }

    notifBell.addEventListener('click', () => {
      notifPanel.classList.toggle('active');
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    });

    // Modal functions
    function openModal(ev) {
      currentEvent = ev;
      document.getElementById('modalEventName').textContent = ev.eventName;
      document.getElementById('modalDate').textContent = ev.eventDate;
      document.getElementById('modalLocation').textContent = ev.location;
      document.getElementById('modalSkills').textContent = ev.reqSkills.join(', ');
      document.getElementById('modalUrgency').textContent = ev.urgency;
      modal.style.display = 'flex';
    }

    modalClose.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    joinBtnModal.onclick = () => { if (currentEvent) joinEvent(currentEvent); };

    // Init
    renderEvents();
    renderNotifs();
  </script>
</body>
</html>
