<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Profile — Volunteer App</title>
  <link href="style.css" rel="stylesheet" type="text/css">
   <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
</head>
<body>

  <script src="storage.js"></script>

<script>
function toggleTheme() {
  const html = document.documentElement;
  if (html.getAttribute('data-theme') === 'dark') {
    html.setAttribute('data-theme', 'light');
    localStorage.setItem('theme', 'light');
  } else {
    html.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  }
}

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
}
</script>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Profile</h1>
      <div>
        <button id="logoutBtn" class="warn">Logout</button>
      </div>
    </div>

    <p class="muted">Complete your profile. Required fields are enforced.</p>

    <form id="profileForm" novalidate>
      <div class="grid">
        <div>
          <label for="fullName">Full Name <span style="color:#ef4444">*</span></label>
          <input id="fullName" type="text" maxlength="50" required>
          <div id="nameErr" class="error"></div>
        </div>

        <div>
          <label for="emailDisplay">Email</label>
          <input id="emailDisplay" type="email" disabled>
        </div>

        <div style="grid-column:1/3; margin-top:6px">
          <label for="addr1">Address 1 <span style="color:#ef4444">*</span></label>
          <input id="addr1" type="text" maxlength="100" required>
          <div id="addr1Err" class="error"></div>
        </div>

        <div style="grid-column:1/3; margin-top:6px">
          <label for="addr2">Address 2 (optional)</label>
          <input id="addr2" type="text" maxlength="100">
        </div>

        <div>
          <label for="city">City <span style="color:#ef4444">*</span></label>
          <input id="city" type="text" maxlength="100" required>
          <div id="cityErr" class="error"></div>
        </div>

        <div>
          <label for="state">State <span style="color:#ef4444">*</span></label>
          <select id="state" required>
            <option value="">-- Select state --</option>
          </select>
          <div id="stateErr" class="error"></div>
        </div>

        <div>
          <label for="zip">Zip Code <span style="color:#ef4444">*</span></label>
          <input id="zip" type="text" maxlength="9" required placeholder="12345 or 12345-6789">
          <div id="zipErr" class="error"></div>
        </div>

        <div>
          <label for="skills">Skills (select one or more) <span style="color:#ef4444">*</span></label>
          <select id="skills" multiple class="skills" required>
            <!-- options added by script -->
          </select>
          <div id="skillsErr" class="error"></div>
        </div>

        <div style="grid-column:1/3;">
          <label for="prefs">Preferences (optional)</label>
          <textarea id="prefs" maxlength="500" placeholder="Any preferences or notes..."></textarea>
        </div>

        <div style="grid-column:1/3;">
          <label>Availability (choose dates) <span style="color:#ef4444">*</span></label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="availDate" type="date">
            <button type="button" id="addDateBtn">Add</button>
          </div>
          <div id="availErr" class="error"></div>
          <div class="dates-list" id="datesList"></div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="primary">Save Profile</button>
        <button type="button" id="viewNotifsBtn" class="primary" style="background:#10b981">Notifications</button>
        <button type="button" onclick="location.href='home.html'">Home</button>
      </div>

      <div id="saveMsg" class="muted" style="margin-top:10px"></div>
    </form>

    <div id="notifsPanel" style="margin-top:12px; display:none;">
      <h3 style="margin:0 0 8px 0">Notifications</h3>
      <div id="notifsList"></div>
    </div>
  </div>

  <script src="profile.js?v=2"></script>
  <script>
    // ========================
    // Elements
    // ========================
    const currentUserRaw = localStorage.getItem('currentUser');
    const currentUser = currentUserRaw ? JSON.parse(currentUserRaw) : null;

    const logoutBtn = document.getElementById('logoutBtn');
    const emailDisplay = document.getElementById('emailDisplay');
    const fullName = document.getElementById('fullName');
    const addr1 = document.getElementById('addr1');
    const addr2 = document.getElementById('addr2');
    const city = document.getElementById('city');
    const stateEl = document.getElementById('state');
    const zip = document.getElementById('zip');
    const skillsEl = document.getElementById('skills');
    const prefs = document.getElementById('prefs');
    const availDate = document.getElementById('availDate');
    const addDateBtn = document.getElementById('addDateBtn');
    const datesList = document.getElementById('datesList');
    const profileForm = document.getElementById('profileForm');
    const saveMsg = document.getElementById('saveMsg');

    const nameErr = document.getElementById('nameErr');
    const addr1Err = document.getElementById('addr1Err');
    const cityErr = document.getElementById('cityErr');
    const stateErr = document.getElementById('stateErr');
    const zipErr = document.getElementById('zipErr');
    const skillsErr = document.getElementById('skillsErr');
    const availErr = document.getElementById('availErr');

    if (!currentUser || !currentUser.email) {
      alert('You are not logged in.');
      window.location.href = 'index.html';
    }

    // ========================
    // Populate dropdowns
    // ========================
    function populateDropdowns() {
      // States
      const states = ProfileAPI.getStates(); // returns [{code, name}, ...]
      states.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.code;
        opt.textContent = s.name;
        stateEl.appendChild(opt);
      });

      // Skills
      const skills = ProfileAPI.getSkills(); // returns array of strings
      skills.forEach(sk => {
        const opt = document.createElement('option');
        opt.value = sk;
        opt.textContent = sk;
        skillsEl.appendChild(opt);
      });
    }

    populateDropdowns();

    // ========================
    // Load user profile
    // ========================
    let userObj = ProfileAPI.loadProfile(currentUser.email);
    if (!userObj) {
      alert('Local account missing. Please sign in again.');
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    // Fill form fields
    emailDisplay.value = currentUser.email;
    const profile = userObj || {};
    fullName.value = profile.fullName || currentUser.name || '';
    addr1.value = profile.address1 || '';
    addr2.value = profile.address2 || '';
    city.value = profile.city || '';
    stateEl.value = profile.state || '';
    zip.value = profile.zip || '';
    prefs.value = profile.preferences || '';

    if (Array.isArray(profile.skills)) {
      Array.from(skillsEl.options).forEach(opt => {
        opt.selected = profile.skills.includes(opt.value);
      });
    }

    // ========================
    // Availability Dates
    // ========================
    window._availDates = profile.availability ? [...profile.availability] : [];

    function renderDates() {
      datesList.innerHTML = '';
      (window._availDates || []).sort().forEach(d => {
        const chip = document.createElement('div');
        chip.className = 'date-chip';
        chip.innerHTML = `<span>${d}</span>
          <button type="button" data-date="${d}" style="background:none;border:none;color:#f87171;cursor:pointer">✕</button>`;
        datesList.appendChild(chip);
      });

      // Remove handler calls backend
      datesList.querySelectorAll('button[data-date]').forEach(b => {
        b.addEventListener('click', (e) => {
          const d = e.currentTarget.getAttribute('data-date');
          window._availDates = ProfileAPI.removeAvailability(currentUser.email, d);
          renderDates();
        });
      });
    }

    renderDates();

    addDateBtn.addEventListener('click', () => {
      const v = availDate.value;
      if (!v) return;
      window._availDates = ProfileAPI.addAvailability(currentUser.email, v);
      renderDates();
      availDate.value = '';
    });

    // ========================
    // Form Validation
    // ========================
    function validZip(z) {
      return /^\d{5}(-\d{4})?$/.test(z.trim());
    }

    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();

      // Clear errors
      nameErr.textContent = '';
      addr1Err.textContent = '';
      cityErr.textContent = '';
      stateErr.textContent = '';
      zipErr.textContent = '';
      skillsErr.textContent = '';
      availErr.textContent = '';
      saveMsg.textContent = '';

      let ok = true;
      if (!fullName.value.trim()) { nameErr.textContent = 'Full name is required.'; ok = false; }
      if (!addr1.value.trim()) { addr1Err.textContent = 'Address 1 is required.'; ok = false; }
      if (!city.value.trim()) { cityErr.textContent = 'City is required.'; ok = false; }
      if (!stateEl.value) { stateErr.textContent = 'Please select a state.'; ok = false; }
      if (!zip.value.trim() || !validZip(zip.value)) { zipErr.textContent = 'Enter a valid zip code.'; ok = false; }
      const selectedSkills = Array.from(skillsEl.selectedOptions).map(o => o.value);
      if (!selectedSkills.length) { skillsErr.textContent = 'Select at least one skill.'; ok = false; }
      if (!window._availDates.length) { availErr.textContent = 'Add at least one availability date.'; ok = false; }
      if (!ok) return;

      // Save profile
      const updatedProfile = {
        fullName: fullName.value.trim(),
        address1: addr1.value.trim(),
        address2: addr2.value.trim(),
        city: city.value.trim(),
        state: stateEl.value,
        zip: zip.value.trim(),
        skills: selectedSkills,
        preferences: prefs.value.trim(),
        availability: window._availDates.slice().sort()
      };

      ProfileAPI.saveProfile(currentUser.email, updatedProfile);

      saveMsg.textContent = 'Profile saved successfully.';
    });

    // ========================
    // Logout
    // ========================
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    });
  </script>


</body>
</html>
