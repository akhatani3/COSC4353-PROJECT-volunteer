<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Volunteer History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0f172a; --card: #111827; --muted: #94a3b8; --text: #e5e7eb;
      --accent: #6366f1; --accent-600: #4f46e5; --ring: rgba(99, 102, 241, 0.35);
    }
    body { margin:0; font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh; }
    header {
      background: var(--card);
      padding:16px 28px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(148,163,184,0.15);
    }
    header .left { display:flex; align-items:center; gap:12px; }
    header img.profile-pic {
      width:42px; height:42px; border-radius:50%;
      border:2px solid var(--accent);
      object-fit:cover;
    }
    header h1 { margin:0; font-size:20px; }
    nav a { color:var(--muted); text-decoration:none; margin-left:18px; font-size:14px; }
    nav a:hover { color:var(--accent); }

    main { flex:1; padding:28px; display:flex; flex-direction:column; align-items:center; }

    .form-card {
      background: var(--card);
      border:1px solid rgba(148,163,184,0.15);
      border-radius:16px;
      padding:30px;
      width:100%;
      max-width:550px;
      box-shadow:0 6px 18px rgba(0,0,0,0.3);
      margin-bottom:20px;
    }

    input, button { width:100%; padding:10px; margin-bottom:14px; border-radius:8px; border:1px solid rgba(148,163,184,0.2); background:#1e293b; color:var(--text); }
    input:focus { outline:2px solid var(--accent); }
    button {
      border:none;
      background:linear-gradient(180deg, var(--accent), var(--accent-600));
      color:white; font-weight:600; cursor:pointer; font-size:16px;
    }
    button:hover { opacity:0.9; }

    .event-list { margin-top:25px; width:100%; max-width:650px; }
    .event-item {
      background:#1f2937; border-radius:12px;
      border:1px solid rgba(148,163,184,0.25);
      padding:16px; margin-bottom:14px;
      transition:background 0.2s;
    }
    .event-item:hover { background:#273244; }
    .event-item h3 { margin:0 0 8px; }
    .event-item button {
      width:auto; margin-top:8px; padding:8px 14px;
      font-size:14px;
    }

    /* Report Button */
    .report-section {
      margin-top: 40px;
      width: 100%;
      max-width: 650px;
      text-align: center;
    }
    .report-btn {
      background: linear-gradient(180deg, #10b981, #059669);
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      color: white;
      transition: all 0.3s;
    }
    .report-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Modal */
    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center; z-index:50;
    }
    .modal.active { display:flex; }
    .modal-content {
      background:var(--card); padding:32px; border-radius:16px;
      width:90%; max-width:420px; position:relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .modal-content h2 { margin-top:0; margin-bottom: 20px; font-size: 22px; }
    .modal-content .close {
      position:absolute; top:12px; right:16px;
      font-size:24px; cursor:pointer; color:var(--muted);
    }
    .modal-content .close:hover { color:var(--accent); }
    
    .format-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .format-btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .format-btn.pdf {
      background: #ef4444;
      color: white;
    }
    .format-btn.pdf:hover {
      background: #dc2626;
    }
    .format-btn.csv {
      background: #22c55e;
      color: white;
    }
    .format-btn.csv:hover {
      background: #16a34a;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <img class="profile-pic" id="profilePic" src="https://via.placeholder.com/100" alt="Profile Picture">
      <h1 id="greeting">Volunteer History</h1>
    </div>
    <nav>
      <a href="admin-events.html">Admin</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main>
    <div class="form-card">
      <h2>Your Profile</h2>
      <form id="profileForm">
        <input id="userEmail" placeholder="Email" />
        <input id="fullName" placeholder="Full Name" />
        <input id="state" placeholder="State" />
        <input id="zipcode" placeholder="Zipcode" />
        <input id="skills" placeholder="Skills (comma separated)" />
        <button type="submit">Save Profile</button>
      </form>
      <p id="status"></p>
    </div>

    <div class="form-card">
      <h2>Available Events</h2>
      <div id="eventList" class="event-list"></div>
    </div>

    <!-- Report Generation Section -->
    <div class="report-section">
      <h2>Generate Participation Report</h2>
      <p style="color: var(--muted); margin-bottom: 20px;">
        Download a comprehensive report of all volunteers and their participation history
      </p>
      <button class="report-btn" id="generateReportBtn">Generate Report</button>
    </div>
  </main>

  <!-- Event Details Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2 id="modalTitle"></h2>
      <p><strong>Date:</strong> <span id="modalDate"></span></p>
      <p><strong>Location:</strong> <span id="modalLocation"></span></p>
      <p><strong>Urgency:</strong> <span id="modalUrgency"></span></p>
      <p><strong>Skills Required:</strong> <span id="modalSkills"></span></p>
      <p><strong>Details:</strong> <span id="modalDetails"></span></p>
    </div>
  </div>

  <!-- Report Format Selection Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeReportModal">&times;</span>
      <h2>Select Report Format</h2>
      <p style="color: var(--muted); margin-bottom: 8px;">Choose your preferred format:</p>
      <div class="format-buttons">
        <button class="format-btn pdf" id="pdfBtn">PDF</button>
        <button class="format-btn csv" id="csvBtn">CSV</button>
      </div>
    </div>
  </div>

  <script>
    const profileForm = document.getElementById('profileForm');
    const statusEl = document.getElementById('status');
    const greeting = document.getElementById('greeting');
    const profilePic = document.getElementById('profilePic');

    const eventList = document.getElementById('eventList');
    const modal = document.getElementById('eventModal');
    const closeModal = document.getElementById('closeModal');

    const reportModal = document.getElementById('reportModal');
    const closeReportModal = document.getElementById('closeReportModal');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const csvBtn = document.getElementById('csvBtn');

    // === Profile ===
    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('fullName').value;
      greeting.textContent = `Welcome, ${name || 'Volunteer'}`;
      statusEl.textContent = "Profile saved successfully!";
      // Note: In production, this should call an API to save to database
      localStorage.setItem('profile', JSON.stringify({
        email: document.getElementById('userEmail').value,
        fullName: name,
        state: document.getElementById('state').value,
        zipcode: document.getElementById('zipcode').value,
        skills: document.getElementById('skills').value
      }));
    });

    // Load saved profile
    const savedProfile = JSON.parse(localStorage.getItem('profile') || '{}');
    if (savedProfile.fullName) {
      document.getElementById('userEmail').value = savedProfile.email || '';
      document.getElementById('fullName').value = savedProfile.fullName || '';
      document.getElementById('state').value = savedProfile.state || '';
      document.getElementById('zipcode').value = savedProfile.zipcode || '';
      document.getElementById('skills').value = savedProfile.skills || '';
      greeting.textContent = `Welcome, ${savedProfile.fullName}`;
    }

    // === Load Events from API ===
    async function loadEvents() {
      try {
        const res = await fetch('/api/events');
        const events = await res.json();
        eventList.innerHTML = '';
        events.forEach(event => {
          const div = document.createElement('div');
          div.className = 'event-item';
          const eventDate = new Date(event.date).toLocaleDateString();
          div.innerHTML = `
            <h3>${event.name}</h3>
            <p>${eventDate} â€” ${event.location}</p>
            <button>View Details</button>
          `;
          div.querySelector('button').addEventListener('click', () => showModal(event));
          eventList.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading events:', error);
        eventList.innerHTML = '<p>Error loading events</p>';
      }
    }

    function showModal(event) {
      modal.classList.add('active');
      document.getElementById('modalTitle').textContent = event.name;
      document.getElementById('modalDate').textContent = new Date(event.date).toLocaleDateString();
      document.getElementById('modalLocation').textContent = event.location;
      document.getElementById('modalUrgency').textContent = event.urgency;
      document.getElementById('modalSkills').textContent = event.skillsRequired?.join(', ') || 'N/A';
      document.getElementById('modalDetails').textContent = event.details || 'No additional details';
    }

    closeModal.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

    // === Report Generation ===
    generateReportBtn.addEventListener('click', () => {
      reportModal.classList.add('active');
    });

    closeReportModal.addEventListener('click', () => reportModal.classList.remove('active'));
    reportModal.addEventListener('click', (e) => { if (e.target === reportModal) reportModal.classList.remove('active'); });

    async function downloadReport(format) {
      try {
        generateReportBtn.disabled = true;
        generateReportBtn.textContent = 'â³ Generating...';

        const response = await fetch(`/api/reports/volunteer-history?format=${format}`);
        
        if (!response.ok) {
          throw new Error('Failed to generate report');
        }

        // Get the blob from response
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `volunteer-history-report.${format}`;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        reportModal.classList.remove('active');
        alert(`${format.toUpperCase()} report downloaded successfully!`);
      } catch (error) {
        console.error('Error downloading report:', error);
        alert('Error generating report. Please try again.');
      } finally {
        generateReportBtn.disabled = false;
        generateReportBtn.textContent = 'ðŸ“Š Generate Report';
      }
    }

    pdfBtn.addEventListener('click', () => downloadReport('pdf'));
    csvBtn.addEventListener('click', () => downloadReport('csv'));

    // Initialize
    loadEvents();
  </script>
</body>
</html>